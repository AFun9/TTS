# Sherpa TTS Android - 需求文档

## 1. 项目概述

Sherpa TTS Android 是一款基于 Sherpa-ONNX 的 Android TTS 应用程序，专门为跨语言 TTS 应用设计。通过 lexicon-first 机制，用户可以使用训练好的模型（如俄语 VITS 模型）生成其他语言（如英语）的发音。

## 1.1 项目背景

现有的 TTS 应用通常只支持单一语言，而用户需要能够使用特定语言训练的模型来生成其他语言的发音。本应用通过自定义词典的方式，实现灵活的跨语言发音控制。

## 2. 功能需求

### 2.1 核心功能

#### FR-001: 文本到语音转换
- **描述**: 将输入文本转换为语音并实时播放
- **输入**: 文本字符串（支持键盘输入和文件导入）
- **输出**: 实时音频播放 + 可选文件保存
- **格式**: 支持 WAV 格式音频输出
- **优先级**: 高

#### FR-002: Lexicon-First 支持
- **描述**: 支持用户自定义词典，优先使用词典发音，未命中词回退到默认 phonemizer
- **输入**: lexicon.txt 文件（通过应用内编辑或文件导入）
- **行为**:
  - 词典存在时：优先查词典进行发音映射
  - 词典不存在时：使用默认 espeak phonemizer
  - 支持实时编辑和保存词典
- **优先级**: 高

#### FR-003: 多语言跨语言支持
- **描述**: 支持使用任意语言训练的模型生成其他语言的发音
- **示例**: 用俄语训练的VITS模型生成英语发音
- **实现**: 通过词典将目标语言映射到模型训练语言的音素空间
- **优先级**: 高

#### FR-004: 音频播放控制
- **描述**: 实时控制音频播放参数
- **参数**:
  - 语速：可调节范围 0.5x - 2.0x
  - 音量：可调节范围 0-100%
  - 暂停/继续播放
  - 停止播放
- **优先级**: 高

#### FR-005: 模型管理
- **描述**: 管理 TTS 模型文件
- **功能**:
  - 导入模型文件（ONNX格式）
  - 导入 token 文件（tokens.txt）
  - 导入/编辑词典文件（lexicon.txt）
  - 模型信息显示（采样率、说话人数量等）
- **优先级**: 高

#### FR-006: 文件导入导出
- **描述**: 支持文本文件和音频文件的导入导出
- **输入格式**: TXT, CSV, JSON
- **输出格式**: WAV, MP3（可选）
- **批量处理**: 支持批量文本转换
- **优先级**: 中

#### FR-007: 用户界面
- **描述**: 提供直观易用的移动端界面
- **组件**:
  - 文本输入框（支持多行输入）
  - 播放控制按钮（播放/暂停/停止）
  - 参数调节滑块（语速、音量）
  - 模型选择器
  - 词典编辑器
  - 文件浏览器
- **优先级**: 高

#### FR-008: 词典编辑器
- **描述**: 内置词典编辑功能
- **功能**:
  - 查看现有词典条目
  - 添加新词典条目
  - 编辑现有条目
  - 删除条目
  - 导入/导出词典文件
  - 词典格式验证
- **优先级**: 高

#### FR-009: 历史记录
- **描述**: 保存转换历史和常用文本
- **功能**:
  - 保存最近的转换记录
  - 收藏常用文本
  - 快速重新播放
- **优先级**: 中

### 2.2 配置管理

#### FR-005: 模型配置
- **描述**: 通过配置文件指定模型、tokens、lexicon 等路径
- **配置项**:
  - model_path: ONNX 模型文件路径
  - tokens_path: tokens.txt 文件路径
  - lexicon_path: lexicon.txt 文件路径（可选）
  - data_dir: espeak-ng 数据目录路径
- **优先级**: 高

#### FR-006: 运行时配置
- **描述**: 运行时可配置的 TTS 参数
- **配置项**:
  - speaker_id: 说话人 ID
  - speed: 语速倍数
  - debug: 调试模式开关
- **优先级**: 中

### 2.3 接口需求

#### FR-007: 命令行接口
- **描述**: 提供命令行工具进行 TTS 转换
- **命令格式**:
  ```bash
  sherpa-tts-wrapper --config config.json --text "Hello world" --output output.wav
  ```
- **优先级**: 高

#### FR-008: Python API
- **描述**: 提供 Python 编程接口
- **使用示例**:
  ```python
  from sherpa_tts_wrapper import TTS

  tts = TTS(config_path="config.json")
  audio = tts.generate("Hello world")
  audio.save("output.wav")
  ```
- **优先级**: 高

## 3. 非功能需求

### 3.1 性能需求

#### NFR-001: 响应时间
- **描述**: 单句 TTS 生成时间应小于 3 秒（考虑移动设备性能）
- **度量**: 95% 的请求在 2.5 秒内完成
- **优先级**: 高

#### NFR-002: 内存使用
- **描述**: 模型加载后内存使用不超过 1GB（移动设备内存限制）
- **度量**: Android Memory Profiler 测量
- **优先级**: 高

#### NFR-003: 电池消耗
- **描述**: 连续使用1小时电池消耗不超过 15%
- **优化**: 使用硬件加速，合理调度推理任务
- **优先级**: 中

### 3.2 Android 平台特性

#### NFR-004: Android API 级别
- **最低版本**: API 24 (Android 7.0)
- **目标版本**: API 34 (Android 14)
- **兼容性**: 支持 armeabi-v7a, arm64-v8a 架构

#### NFR-005: 存储管理
- **内部存储**: 模型文件存储在应用私有目录
- **外部存储**: 输出音频可保存到外部存储
- **权限**: 合理使用存储权限，仅在需要时请求

#### NFR-006: 后台处理
- **推理任务**: 在后台线程执行，避免阻塞UI
- **进度显示**: 提供进度条和状态反馈
- **取消支持**: 支持取消正在进行的任务

### 3.2 可靠性需求

#### NFR-003: 错误处理
- **描述**: 对无效输入进行优雅处理并给出明确错误信息
- **错误类型**:
  - 文件不存在
  - 模型格式错误
  - 词典格式错误
  - 文本编码问题
- **优先级**: 高

#### NFR-004: 日志记录
- **描述**: 提供详细的运行日志用于调试和监控
- **日志级别**: DEBUG, INFO, WARNING, ERROR
- **优先级**: 中

### 3.3 可维护性需求

#### NFR-005: 代码结构
- **描述**: 代码应模块化，易于理解和维护
- **要求**:
  - 分离关注点
  - 单一职责原则
  - 清晰的接口定义
- **优先级**: 高

#### NFR-006: 配置管理
- **描述**: 配置应集中管理，支持环境变量覆盖
- **格式**: JSON 配置文件
- **优先级**: 中

## 4. 用户场景

### 4.1 场景 1: 语言学习者
**用户**: 外语学习者
**目标**: 使用母语发音学习外语发音
**使用流程**:
1. 下载目标语言的 TTS 模型
2. 创建词典，将外语单词映射到母语发音
3. 在应用中输入外语文本
4. 听到以母语方式发音的外语单词
5. 对比标准发音进行练习

### 4.2 场景 2: 内容创作者
**用户**: 视频/音频内容创作者
**目标**: 为特定品牌词或专有名词定制发音
**使用流程**:
1. 导入基础 TTS 模型
2. 在词典编辑器中添加品牌词的特殊发音
3. 批量转换脚本文本
4. 导出音频文件用于视频制作

### 4.3 场景 3: 开发者/研究人员
**用户**: TTS 算法研究者
**目标**: 快速验证跨语言 TTS 效果
**使用流程**:
1. 导入不同语言训练的模型
2. 创建语言间音素映射词典
3. 测试各种语言转换效果
4. 对比不同映射策略的结果
5. 导出音频进行客观评价

### 4.4 场景 4: 无障碍用户
**用户**: 视力障碍或 dyslexia 用户
**目标**: 使用熟悉的发音方式听取文本
**使用流程**:
1. 选择母语 TTS 模型
2. 创建文本到母语发音的映射词典
3. 导入需要转换的文档
4. 听取以熟悉方式发音的文本内容

## 5. 约束条件

### 5.1 技术约束

#### TC-001: Android 平台约束
- **开发语言**: Kotlin/Java
- **JNI**: 通过 JNI 调用 Sherpa-ONNX C++ 库
- **构建工具**: Android Gradle Plugin 8.0+
- **依赖管理**: Maven Central 或 JCenter

#### TC-002: Sherpa-ONNX 集成
- **版本**: Sherpa-ONNX 1.12.0+
- **ABI**: armeabi-v7a, arm64-v8a
- **编译选项**: 启用 TTS 功能，包含 espeak-ng 支持

#### TC-003: 文件格式
- **模型**: ONNX 格式
- **音频**: WAV 格式（核心），可选 MP3
- **词典**: UTF-8 纯文本格式
- **配置**: JSON 格式存储在 SharedPreferences

### 5.2 Android 特定约束

#### AC-001: 权限管理
- **存储权限**: READ_EXTERNAL_STORAGE, WRITE_EXTERNAL_STORAGE (API < 29)
- **媒体权限**: READ_MEDIA_AUDIO (API >= 30)
- **最小权限原则**: 仅在需要时请求权限

#### AC-002: 存储限制
- **应用私有目录**: 存储模型文件（无大小限制）
- **外部存储**: 输出音频文件（用户可访问）
- **缓存目录**: 临时音频文件（系统可清理）

#### AC-003: 内存和性能
- **内存限制**: 应用内存使用不超过 1GB
- **后台限制**: Android 8.0+ 对后台服务限制
- **电池优化**: 避免长时间后台推理

### 5.3 硬件约束

#### HC-001: 设备要求
- **最低配置**: Android 7.0 (API 24), 2GB RAM
- **推荐配置**: Android 10.0+, 4GB RAM, 支持 NNAPI
- **架构支持**: ARMv7, ARM64

#### HC-002: 模型大小限制
- **最大模型大小**: 考虑移动网络下载，单个模型不超过 500MB
- **存储空间**: 应用安装后至少需要 1GB 可用空间

### 5.4 法律约束

#### LC-001: 开源协议
- **代码**: Apache 2.0 License
- **文档**: CC-BY-SA 4.0

#### LC-002: Google Play 要求
- **隐私政策**: 必须提供，用户数据处理说明
- **权限说明**: 清晰说明为什么需要存储权限
- **内容分级**: 适合全年龄段使用

## 6. 验收标准

### 6.1 功能验收

#### Android 应用功能
- [ ] 应用能够成功安装和启动
- [ ] 能够导入 ONNX 模型文件
- [ ] 能够导入 tokens.txt 文件
- [ ] 能够导入/编辑 lexicon.txt 文件
- [ ] 文本输入界面工作正常
- [ ] TTS 转换按钮响应正确
- [ ] 音频播放功能正常
- [ ] 文件保存功能正常

#### 核心 TTS 功能
- [ ] 能够成功加载 VITS 模型
- [ ] 能够使用 lexicon 覆盖默认发音
- [ ] 能够生成正确格式的 WAV 文件
- [ ] Lexicon-first 机制工作正常
- [ ] 回退到默认 phonemizer 正常工作

#### 用户界面功能
- [ ] 词典编辑器界面完整
- [ ] 模型管理界面正常
- [ ] 播放控制界面响应正确
- [ ] 文件导入导出功能正常
- [ ] 设置界面配置正确

### 6.2 性能验收

#### Android 性能指标
- [ ] 应用启动时间 < 3秒
- [ ] 单句 TTS 生成时间 < 3秒（中端设备）
- [ ] 内存使用峰值 < 1GB
- [ ] 电池消耗合理（1小时 < 15%）
- [ ] 应用包大小 < 50MB（不含模型）

#### TTS 性能指标
- [ ] 模型加载时间 < 10秒
- [ ] 词典加载时间 < 2秒
- [ ] 支持并发推理（至少 1 个后台任务）
- [ ] 长时间运行稳定（无内存泄漏）

### 6.3 兼容性验收

#### 设备兼容性
- [ ] 支持 Android 7.0-14.0
- [ ] 支持 ARMv7 和 ARM64 架构
- [ ] 在主流设备上运行稳定
- [ ] 屏幕适配正常（手机、平板）

#### 功能兼容性
- [ ] 支持不同大小的模型文件
- [ ] 支持各种编码的文本输入
- [ ] 支持中英文词典混合使用
- [ ] 支持动态词典更新

### 6.4 质量验收

#### 代码质量
- [ ] 单元测试覆盖率 > 70%
- [ ] 集成测试覆盖主要功能
- [ ] 错误处理完善，无崩溃
- [ ] 代码结构清晰，模块化好

#### 用户体验
- [ ] 界面响应流畅，无卡顿
- [ ] 操作反馈及时准确
- [ ] 错误提示友好清晰
- [ ] 帮助文档完善易懂

#### 稳定性
- [ ] 长时间使用无内存泄漏
- [ ] 异常情况处理正确
- [ ] 数据持久化可靠
- [ ] 应用重启后状态恢复

## 7. 风险评估

### 7.1 技术风险

#### TR-001: 模型兼容性
- **描述**: 不同版本的 Sherpa-ONNX 可能有 API 变化
- **缓解**: 锁定 Sherpa-ONNX 版本，使用适配层

#### TR-002: 依赖管理
- **描述**: ONNX Runtime 等依赖的版本兼容性
- **缓解**: 使用固定版本，定期测试

### 7.2 业务风险

#### BR-001: 发音质量
- **描述**: lexicon 映射可能导致不自然发音
- **缓解**: 提供验证工具，用户测试调整

#### BR-002: 性能瓶颈
- **描述**: 大模型可能导致推理速度慢
- **缓解**: 支持模型量化，优化推理流程

## 8. 术语表

- **VITS**: Variational Inference with adversarial learning for Text-to-Speech
- **ONNX**: Open Neural Network Exchange 格式
- **Lexicon**: 发音词典，将单词映射到音素序列
- **Phonemizer**: 将文本转换为音素的工具
- **TTS**: Text-to-Speech 文本到语音转换